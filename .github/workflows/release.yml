name: Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 2.0.0)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (test without publishing)'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.11'

jobs:
  validate-release:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      should_publish: ${{ steps.check.outputs.should_publish }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix if present
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Validate version format
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$'; then
            echo "Invalid version format: $VERSION"
            echo "Expected format: X.Y.Z or X.Y.Z-suffix"
            exit 1
          fi
          echo "âœ“ Version format is valid"

      - name: Check if version already exists on PyPI
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          if pip index versions log-filter | grep -q "$VERSION"; then
            echo "::warning::Version $VERSION already exists on PyPI"
          else
            echo "âœ“ Version $VERSION is new"
          fi
        continue-on-error: true

      - name: Check version in pyproject.toml
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          TOML_VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          if [ "$VERSION" != "$TOML_VERSION" ]; then
            echo "::error::Version mismatch: tag=$VERSION, pyproject.toml=$TOML_VERSION"
            exit 1
          fi
          echo "âœ“ Version matches pyproject.toml"

      - name: Check CHANGELOG
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          if ! grep -q "$VERSION" CHANGELOG.md; then
            echo "::warning::Version $VERSION not found in CHANGELOG.md"
          else
            echo "âœ“ Version found in CHANGELOG.md"
          fi

      - name: Determine if should publish
        id: check
        run: |
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "should_publish=false" >> $GITHUB_OUTPUT
            echo "Dry run mode - will not publish"
          else
            echo "should_publish=true" >> $GITHUB_OUTPUT
            echo "Will publish to registries"
          fi

  run-tests:
    name: Run Full Test Suite
    needs: validate-release
    uses: ./.github/workflows/ci.yml

  build-package:
    name: Build Python Package
    runs-on: ubuntu-latest
    needs: [validate-release]
    outputs:
      wheel_name: ${{ steps.build.outputs.wheel_name }}
      sdist_name: ${{ steps.build.outputs.sdist_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install build twine check-manifest

      - name: Verify MANIFEST.in
        run: check-manifest --verbose

      - name: Build package
        id: build
        run: |
          python -m build
          
          # Get package names
          WHEEL_NAME=$(ls dist/*.whl | xargs -n 1 basename)
          SDIST_NAME=$(ls dist/*.tar.gz | xargs -n 1 basename)
          
          echo "wheel_name=$WHEEL_NAME" >> $GITHUB_OUTPUT
          echo "sdist_name=$SDIST_NAME" >> $GITHUB_OUTPUT
          
          echo "Built packages:"
          ls -lh dist/

      - name: Verify package
        run: |
          twine check --strict dist/*
          
          # Test wheel installation
          python -m venv test-env
          source test-env/bin/activate
          pip install dist/*.whl
          
          # Verify installation
          log-filter --version
          python -c "import log_filter; print(f'Installed version: {log_filter.__version__}')"
          
          # Test basic functionality
          echo "2026-01-08 ERROR Test error" | log-filter "ERROR" -
          
          deactivate

      - name: Generate checksums
        run: |
          cd dist
          sha256sum * > SHA256SUMS
          cat SHA256SUMS

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-packages
          path: dist/
          retention-days: 90

  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [validate-release, run-tests, build-package]
    if: needs.validate-release.outputs.should_publish == 'true'
    environment:
      name: pypi
      url: https://pypi.org/project/log-filter/
    permissions:
      id-token: write  # For trusted publishing
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-packages
          path: dist/

      - name: Publish to Test PyPI
        if: github.event_name == 'workflow_dispatch'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          skip-existing: true
          verbose: true

      - name: Publish to PyPI
        if: github.event_name == 'release'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          skip-existing: true
          verbose: true

      - name: Verify PyPI publication
        if: github.event_name == 'release'
        run: |
          VERSION="${{ needs.validate-release.outputs.version }}"
          
          # Wait for PyPI to propagate
          sleep 30
          
          # Verify version is available
          pip index versions log-filter | grep "$VERSION" || \
            (echo "Version $VERSION not found on PyPI after publication" && exit 1)
          
          echo "âœ“ Version $VERSION successfully published to PyPI"

  build-docker:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: [validate-release, run-tests]
    if: needs.validate-release.outputs.should_publish == 'true'
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: github.event_name == 'release'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ secrets.DOCKERHUB_USERNAME }}/log-filter
            ghcr.io/${{ github.repository }}
          tags: |
            type=semver,pattern={{version}},value=${{ needs.validate-release.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.validate-release.outputs.version }}
            type=semver,pattern={{major}},value=${{ needs.validate-release.outputs.version }}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker images
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ needs.validate-release.outputs.version }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

      - name: Test Docker image
        run: |
          docker run --rm ghcr.io/${{ github.repository }}:${{ needs.validate-release.outputs.version }} log-filter --version

  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate-release, run-tests, build-package, publish-pypi]
    if: github.event_name == 'release'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-packages
          path: dist/

      - name: Generate release notes
        id: notes
        run: |
          VERSION="${{ needs.validate-release.outputs.version }}"
          
          # Extract changelog for this version
          sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | sed '$d' > release-notes.md
          
          # Add installation instructions
          cat >> release-notes.md << EOF
          
          ## Installation
          
          \`\`\`bash
          pip install log-filter==$VERSION
          \`\`\`
          
          ## Docker
          
          \`\`\`bash
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/log-filter:$VERSION
          \`\`\`
          
          ## Checksums
          
          \`\`\`
          $(cat dist/SHA256SUMS)
          \`\`\`
          EOF
          
          cat release-notes.md

      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/*.whl
            dist/*.tar.gz
            dist/SHA256SUMS
          body_path: release-notes.md
          token: ${{ secrets.GITHUB_TOKEN }}

  notify-success:
    name: Notify Release Success
    runs-on: ubuntu-latest
    needs: [validate-release, publish-pypi, build-docker, create-github-release]
    if: success()
    steps:
      - name: Summary
        run: |
          VERSION="${{ needs.validate-release.outputs.version }}"
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # âœ… Release $VERSION Successful!
          
          ## Published to:
          - ðŸ“¦ PyPI: https://pypi.org/project/log-filter/$VERSION/
          - ðŸ³ Docker Hub: \`docker pull ${{ secrets.DOCKERHUB_USERNAME }}/log-filter:$VERSION\`
          - ðŸ“¦ GitHub Container Registry: \`docker pull ghcr.io/${{ github.repository }}:$VERSION\`
          - ðŸ“ GitHub Release: ${{ github.server_url }}/${{ github.repository }}/releases/tag/v$VERSION
          
          ## Next Steps:
          - âœ“ Update documentation
          - âœ“ Announce on social media
          - âœ“ Update downstream projects
          EOF

  notify-failure:
    name: Notify Release Failure
    runs-on: ubuntu-latest
    needs: [validate-release, publish-pypi, build-docker, create-github-release]
    if: failure()
    steps:
      - name: Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # âŒ Release Failed
          
          Check the logs above for details on what went wrong.
          
          ## Troubleshooting:
          - Verify version format
          - Check pyproject.toml version matches
          - Ensure all tests pass
          - Verify secrets are configured
          EOF

