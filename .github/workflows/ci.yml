name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
  schedule:
    # Run every Monday at 00:00 UTC to catch dependency issues
    - cron: '0 0 * * 1'

env:
  PYTHON_VERSION: '3.11'
  CACHE_VERSION: v1

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ env.CACHE_VERSION }}-${{ runner.os }}-pip-${{ hashFiles('**/requirements-dev.txt') }}
          restore-keys: |
            ${{ env.CACHE_VERSION }}-${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements-dev.txt

      - name: Run Black (formatting)
        run: |
          echo "::group::Black Results"
          black --check --diff src/ tests/
          echo "::endgroup::"

      - name: Run isort (import sorting)
        run: |
          echo "::group::isort Results"
          isort --check-only --diff src/ tests/
          echo "::endgroup::"

      - name: Run Flake8 (linting)
        run: |
          echo "::group::Flake8 Results"
          flake8 src/ tests/ --statistics --count
          echo "::endgroup::"

      - name: Run Pylint (code analysis)
        run: |
          echo "::group::Pylint Results"
          pylint src/log_filter/ --output-format=colorized --score=yes
          echo "::endgroup::"
        continue-on-error: true

      - name: Run mypy (type checking)
        run: |
          echo "::group::mypy Results"
          mypy src/log_filter/ --show-error-codes --pretty
          echo "::endgroup::"

      - name: Check for problematic print statements
        run: |
          echo "::group::Print Statement Check"
          # Allow print() in specific contexts:
          # - Statistics modules (reporter.py, summary.py) - report formatting
          # - With file= parameter (stderr, file handles)
          # - In docstrings (>>>, ...)
          # - With # noqa comment (documented exceptions)

          # Only flag naked print() calls that may be debug statements
          PROBLEMATIC=$(grep -rn "print(" src/log_filter/ \
            | grep -v "/statistics/reporter.py:" \
            | grep -v "/statistics/summary.py:" \
            | grep -v "file=" \
            | grep -v ">>>" \
            | grep -v "\.\.\." \
            | grep -v "sys.stderr" \
            | grep -v "def print" \
            | grep -v "# noqa" \
            | grep -v ":[0-9]*:\s*#" \
            || true)

          if [ -n "$PROBLEMATIC" ]; then
            echo "Found potentially problematic print() statements:"
            echo "$PROBLEMATIC"
            echo ""
            echo "Note: print() is allowed in statistics modules, with file= parameter,"
            echo "      in docstrings, to sys.stderr, or with # noqa comment"
            exit 1
          fi

          echo "✓ No problematic print() statements found"
          echo "::endgroup::"

      - name: Check for TODO/FIXME comments
        run: |
          echo "::group::TODO/FIXME Check"
          grep -r "TODO\|FIXME" src/ tests/ || echo "No TODO/FIXME found"
          echo "::endgroup::"
        continue-on-error: true

  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
        exclude:
          # Skip some combinations to speed up CI
          - os: macos-latest
            python-version: '3.8'
          - os: macos-latest
            python-version: '3.9'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/Library/Caches/pip
            ~\AppData\Local\pip\Cache
          key: ${{ env.CACHE_VERSION }}-${{ runner.os }}-${{ matrix.python-version }}-pip-${{ hashFiles('**/requirements-dev.txt') }}
          restore-keys: |
            ${{ env.CACHE_VERSION }}-${{ runner.os }}-${{ matrix.python-version }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements-dev.txt
          pip install -e .

      - name: Display environment info
        run: |
          python --version
          pip list
          python -c "import sys; print('Python:', sys.version); print('Platform:', sys.platform)"

      - name: Run unit tests
        run: |
          pytest tests/unit/ -v \
            --cov=log_filter \
            --cov-report=xml \
            --cov-report=term \
            --cov-report=html \
            --junitxml=junit-${{ matrix.os }}-${{ matrix.python-version }}.xml \
            --tb=short

      - name: Run integration tests
        run: |
          pytest tests/integration/ -v \
            --tb=short \
            --maxfail=3

      - name: Run performance tests
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        run: |
          pytest tests/performance/ -v \
            --benchmark-only \
            --benchmark-sort=name \
            --benchmark-json=benchmark.json
        continue-on-error: true

      - name: Run security tests
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        run: |
          pytest tests/security/ -v --tb=short
        continue-on-error: true

      - name: Run chaos tests
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        run: |
          pytest tests/chaos/ -v --tb=short
        continue-on-error: true

      - name: Upload coverage to Codecov
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-${{ matrix.os }}-${{ matrix.python-version }}
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}-${{ matrix.python-version }}
          path: |
            junit-*.xml
            htmlcov/
            .coverage
          retention-days: 30

      - name: Upload benchmark results
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            benchmark.json
            .benchmarks/
          retention-days: 90

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit[toml] safety pip-audit

      - name: Run Bandit (security linter)
        run: |
          echo "::group::Bandit Security Scan"
          bandit -r src/ -f json -o bandit-report.json || true
          bandit -r src/ -f screen
          echo "::endgroup::"

      - name: Run Safety (dependency vulnerability check)
        run: |
          echo "::group::Safety Check"
          safety check --json --output safety-report.json || true
          safety check
          echo "::endgroup::"
        continue-on-error: true

      - name: Run pip-audit (dependency audit)
        run: |
          echo "::group::pip-audit"
          pip-audit --desc --format json --output pip-audit-report.json || true
          pip-audit --desc
          echo "::endgroup::"
        continue-on-error: true

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json
            pip-audit-report.json
          retention-days: 90

      - name: CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: python

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  build:
    name: Build Package
    runs-on: ubuntu-latest
    needs: [code-quality, test]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for version detection

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install build twine check-manifest

      - name: Check MANIFEST.in
        run: check-manifest --verbose

      - name: Build package
        run: python -m build

      - name: Check package
        run: |
          twine check --strict dist/*
          ls -lh dist/

      - name: Test wheel installation
        run: |
          python -m venv test-env
          source test-env/bin/activate
          pip install dist/*.whl
          log-filter --version
          python -c "import log_filter; print(f'Version: {log_filter.__version__}')"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-packages
          path: dist/
          retention-days: 90

  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [test]
    if: github.event_name != 'schedule'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ env.CACHE_VERSION }}-${{ runner.os }}-buildx-${{ hashFiles('Dockerfile') }}
          restore-keys: |
            ${{ env.CACHE_VERSION }}-${{ runner.os }}-buildx-

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: log-filter:test
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          build-args: |
            VERSION=2.0.0
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

      - name: Test Docker image
        run: |
          docker run --rm log-filter:test log-filter --version
          docker run --rm log-filter:test log-filter --help

      - name: Scan Docker image for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: log-filter:test
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

      # Move cache to prevent growing size
      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

  documentation:
    name: Documentation Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install -e .

      - name: Build Sphinx documentation
        run: |
          cd docs
          make html SPHINXOPTS="--keep-going -n"

      - name: Check documentation links
        run: |
          cd docs
          make linkcheck
        continue-on-error: true

      - name: Check documentation spelling
        run: |
          pip install sphinxcontrib-spelling pyenchant
          cd docs
          make spelling || true
        continue-on-error: true

      - name: Upload documentation
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: docs/_build/html/
          retention-days: 30

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high

  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip-licenses

      - name: Check licenses
        run: |
          pip install -r requirements.txt
          pip-licenses --format=markdown --output-file=licenses.md
          cat licenses.md

      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: licenses.md
          retention-days: 90

  all-checks-pass:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [code-quality, test, security, build, docker, documentation]
    if: always()
    steps:
      - name: Check if all required jobs passed
        run: |
          if [[ "${{ needs.code-quality.result }}" != "success" || \
                "${{ needs.test.result }}" != "success" || \
                "${{ needs.security.result }}" != "success" || \
                "${{ needs.build.result }}" != "success" || \
                "${{ needs.docker.result }}" != "success" || \
                "${{ needs.documentation.result }}" != "success" ]]; then
            echo "One or more required checks failed"
            exit 1
          fi
          echo "✓ All required checks passed!"

      - name: Report success
        run: |
          echo "::notice::All CI checks passed successfully! Ready for merge."

